---
# Choose from this list of Journals:
journal: "Water Resources Research"
# Use draft to submit a paper
classoption: "draft,linenumbers"
title: "Water Level Errors and their Impact on True Water Level Uncertainty"
# First name or initial followed by last name
authors:
  - name: Joseph P. Shannon
    affil: 1
    thanks: Joe's Thanks
  # - name: Fred T. Secondauthor
  #   affil: 1
  #   thanks: "Current address: Some other place, Germany"
  # - name: I. Ken Groupleader
  #   affil: "1, 2"
affiliations:
  - number: 1
    name: "Michigan Technological University, College of Forest Resources and Environmental Science"
  # - number: 2
  #   name: "The second affiliation"
corresponding_author:
  - name: Joseph P. Shannon
    email: jpshanno@mtu.edu
keypoints:  
  - "List up to three key points (at least one is required)"
  - "Key Points summarize the main points and conclusions of the article"
  - "Each must be 100 characters or less with no special characters or punctuation"
abstract: "However, compensation approaches are a critical tool for correcting previous monitoring data that may not have subscribed to best practices, or when it is unknown if deployment followed best practices."
plain_language_summary: "Some journals require a plain language summary. See: https://publications.agu.org/author-resource-center/text-requirements/#abstract"
output: 
    bookdown::word_document2:
    bookdown::pdf_document2:
      base_format: rticles::agu_article
bibliography: "`r rbbt::bbt_write_bib('biblio.bib', translator = 'bibtex', overwrite = TRUE)`"
header-includes: 
      - \usepackage{soulutf8}  # For UTF8 chars in TrackChanges
# AGU recommends using the trackchanges LaTeX package in the edition process
# which is available from this link:
# https://publications.agu.org/files/2019/02/January-14-2019-latex-templates.zip
---

```{r setup, echo=FALSE, message = FALSE, warning = FALSE}

source("/home/jpshanno/Documents/Levellogger_Correction/code/levellogger_packages.R")
source("/home/jpshanno/Documents/Levellogger_Correction/code/levellogger_functions.R")
# Some recommended settings. 
knitr::opts_chunk$set(
	fig.cap = "Please caption every figure",
	fig.pos = "h",
	include = FALSE,
	out.extra = ""
)
loadd(combined_data)
loadd(bootstrap_models)
```

```{r keypoints_check, echo=FALSE, results='asis', eval = TRUE}
# This chunk adds a warning if any keypoint is longer than 100 characters. 
# To disable it, you can remove it or set eval to FALSE.
if (any(nchar(rmarkdown::metadata$keypoints) > 100)) {
  cat("\\textcolor{red}{\\textbf{Warning}: keypoint(s)", 
      knitr::combine_words(which(nchar(rmarkdown::metadata$keypoints) > 100)), 
      "longer than 100 characters.}")
}
```

# Notes

Say if the manufacturers state the source of the errors. What causes the error,
and why do I need to still compensate for it.

Figure 1 explanation: state more clearly that it is two interacting errors, not
delta T. State how some models may not be counteracting, but instead will be
compounding

Figure 3: Add panel C showing what is in Panel 4. Panel A + Panel B = Panel C.
Panel B shows no pattern and errors within range of instrument error, might be
good to build up into a relationship for Figure 1

Put uncertainty things first in the introduction and methods. Expand uncertainty
in introduction. In other words, focus on the uncertainty discussion and what it
means for diurnal signals. That is the novel work

# Introduction

Hydrologic monitoring for research and management, including monitoring wells,
piezometers, and stream discharge, often utilizes submerged pressure-transducer
to measure water levels. These instruments are easy to deploy, require minimum
access to the instrument, and provide long-term continuous records in an easily
analyzed format via on-board datalogging. They have been developed in two major
configurations: absolute or unvented, and gauge or vented. Absolute transducers
measure pressure relative to some fixed pressure contained on one side of a
flexible membrane. Gauge transducers measure pressure across a similar membrane
relative to a chamber connected to the atmosphere via a vent tube. Speaking
generally of pressure transducers in hydrologic monitoring, it has been pointed
out that "these systems commonly are not adequately supported by
quality-assurance procedures." [@freeman-2004, p. 1]. And upon studying the
impacts of temperature and temperature gradients on water level measurement
errors @liu-2015 (p. 72) concluded that "measurement of the
water level...is not simple". Even the relatively simple task of measuring water
level in a tank may be confounded by propagating instrument uncertainty through 
to final water levels [@tamari-2010]. 

In the above quote @liu-2015 were commenting on additional uncertainty that
absolute temperature and temperature gradients introduce into water level
measurements. @freeman-2004 went highlighted water temperature gradients as a
potential source of error, and in the same year @cain-2004 examined
temperature-derived artifacts within gauge transducers. Within absolute
transducers artifacts were shown to arise from the temperature of instrument
[@moore-2016], as well as from differing thermal regimes between barometric and
water pressure instruments [@cuevas-2010; @mclaughlin-2011]. @liu-2015 and 
@moore-2016 go on to suggest that all transducers be tested for inaccuracies
over the range of temperature measurements and individual compensation equations
be developed to apply to collected data.

@mclaughlin-2011 concluded that temperature differentials between water and
barometric pressure measurements introduced detectable artifacts with a 1.5 cm
increase in the diurnal variation. This result is similar to @cuevas-2010, who
found a 19% increase in streamflow diurnal fluctuation when barometric and water
transducers were deployed in different thermal settings. Both
@mclaughlin-2011 and @cuevas-2010 focused on absolute transducers, but similar
work has also been performed using vented gauge transducers. @cain-2004 found
that temperature changes within the vent-tube of gauge pressure transducers
introduce water level artifacts, which was explored further by
@liu-2015 in multi-day laboratory and long-term field experiments. Their
findings show that errors can be introduced due to water temperature or rapid
fluctuations in air temperature. Their laboratory experiment found 1.4
$mm^oC^{-1}$ error as water temperature changed (with constant air temperature).
These corrections corresponded to errors of up to 7mm in their field
experiments, with at least some of that error due to the rate of temperature
change affecting the connection to the atmosphere via the vent tube. We can
expect that errors will be introduced with more rapid temperature fluctuations
They also highlight the impact of rate of temperature change, with more rapid
gradients inducing larger water level errors. Errors due to rapid temperature
flucations can be expected to affect both absolute and gauge transducers as
internal electronics and membranes must equilibrate to the new temperatures
[@freeman-2004].

Based on those studies the potential sources of error for absolute transducers 
are the water temperature, the air temperature, the difference between water and
air temperature, and the rate of change for both water and air temperature. 
Previous studies have examined absolute transducer error due to individual 
transducer error [@moore-2016] and due to temperature differences between transducers [@mclaughlin-2011]. @liu-2015 lays out the underlying physics that could lead to 
gauge transducer errors when a temperature difference exists along the vent tube.
There is no analagous physical process for absolute transducers, which suggests 
that errors assumed to arise from temperature differences in these studies may 
be misattributed. We present the alternative hypothesis that that perceived 
temperature difference error is the combination of individual transducer 
responses to water and air temperatures (Figure \@ref(fig:figure-1)). 
The out of phase variation in air temperature and water temperature result in 
the stronger gradient masking the effect of the weaker gradient. The sequential 
correction shown in Figure \@ref{fig:figure-1} illustrates how both errors must 
be addressed. There are two possible approaches to the correction. Develop univariate 
corrections to some reference pressure measurement for each transducer, or develop
a single multi-variate correction for each pair of air and water transducers. By
developing a single multi-variate correction we can avoid the need to determine
a suitable reference pressure measurement or utilize a pressure chamber.

__Figure 1 should be what the description of figure 3 above says. Show error 
from air temp and uncorrected error from water temp. Then show error as corrected
for air and water temp.__

```{r figure-1, fig.cap="Figure 1: Water level error as function of water temperature recorded by the instrument. The line sequential connects the data point and the line color indicates the temperature difference between the water and air. The black point represents the start of the experimental period with a clockwise hystersis loop. The dashed lines represent the combined errors of the water pressure transducer and F3311 barometric sensor."}

knitr::include_graphics("../output/figures/figure_1.png")

```

Implied in the above studies is additional error, beyond instrument accuracy,
that should be considered in the estimate of total measurement uncertainty. It
is also clear that temperature-induced errors will be most apparent in field
data when examining diurnal signals. Many studies have relied on the diurnal
signal in well water levels and streamflow to estimate evapotranspiration and
groundwater flow [@carlsonmazur-2014;
@kirchner-2009; @loheide-2005; @mclaughlin-2014; @watras-2017; @white-1932].
Without accounting for total uncertainty analysis of diurnal signals will lead
to skewed results as the initial inaccuracies compound. Therefore, quantifying
and correcting for temperature-induced errors is essential to ensure that the
observed fluctuations are real and not an artifact. Cuevas [-@cuevas-2010] and
Gribovszki [-@gribovszki-2013] do validate their measurements with manual
readings over the course of at least one 24-hour period. To be fully effective
in field studies, these types of diurnal fluctuation validations would have to
happen across the range of temperature and evapotranspiration/groundwater
measurements throughout the monitoring period. This is often unfeasible for
reasons related, but not limited to, budget, logistics, and safety. This leaves
laboratory-derived compensation equations as the best alternative option, as
recommended by Moore [-@moore-2016] and Liu [-@liu-2015].

Previous work has focused on the role of laboratory-derived compensation 
equations in correcting for temperature-derived errors in water level measurements.
These equations also provide two other opportunities. They can be used to 
generate more robust accuracy ranges for uncorrected data, and they can be used
to create narrower accuracy ranges than instrument accuracy alone. The former
is an important consideration when quantifying diurnal signals. Any diurnal 
signal that is less than the full uncertainty range of the instrument accuracy
and temperature-driven errors must be considered suspect and indistinguishable
from noise. Without additional validation (through manual measurements
or other instrumentation), diurnal patterns below this detection limit would be
considered artifacts, and estimates of such diurnal signals should
be analyzed as left-censored datasets. Inversely, a validated compensation equation, 
developed under the same conditions as monitoring, could be used to improve 
estimates of uncertainty. By validating the compensation equation on an 
independent dataset a new accuracy range can be determined and used for 
corrected datasets. With a well constructed compensation equation these will 
shrink the uncertainty bounds and allow for analysis of more precise diurnal
signals.

In this note we present a lab experiment to isolate and correct the separate
impacts of transducer response to water and air temperatures. We demonstrate how
these effects may mask one another resulting in water level errors within the
range of instrument error. We present the corrected and uncorrected water levels
on a test set of laboratory data at as well representative data from an ongoing
hydrologic field study. Finally we calculate the propagated uncertainty for 
common transducer deployment conditions, compare this to instrument error, and 
evaluate both against published diurnal water level fluctuations.

# Materials and Methods

## Data Collection & Preparation

### Laboratory Data

We have conducted a five day-long experiment recording constant water levels
using absolute pressure transducers in four thermal settings to determine the
impact of varying water and air temperatures, and temperature difference. The
thermal settings represent a fully crossed design with stable and variable
temperatures and similar and dissimilar air and water thermal regimes, with two
periods of variable, dissimilar conditions (Table
\@ref(tab:experiments)). Eighteen pressure transducers of varying age and model,
all manufactured by Solinst, Ltd. (Georgetown, ON, Canada), were used to record
water levels (Table \@ref(tab:loggers)). Two of these transducers, both Solinst
Levellogger Juniors, were used to monitor barometric pressure. All instruments
contained an absolute pressure transducer, temperature sensor, and on-board data
logging. These loggers also provide internal temperature compensation of
pressure measurements.

```{r experiments}
experiments <- 
  data.table(Experiment = c("stat-sim", "stat-dis", "var-sim", "var-dis", "test-data"),
             Temperature = c("Stable", "Stable", "Variable", "Variable", "Variable"),
             `Air/Water Temperature Differential` = c("Similar", "Dissimilar", "Similar", "Dissimilar", "Dissimilar"))

knitr::kable(experiments,
             align = "c",
             caption = "Description of experimental conditions.")
```

```{r loggers}
drake::loadd(logger_metadata)
knitr::kable(logger_metadata[, .(`Number of Loggers` = .N, `Pressure Resolution (cm)` = mean(pressure_resolution_cm), `Pressure Error (cm)` = mean(pressure_error_cm), `Temperature Resolution (C)` = mean(temperature_resolution_cm), `Temperature Error (C)` = mean(temperature_error_c)), by = .(Model = instrument_type)],
             align = "c",
             caption = "Summary of pressure transducer model type, measurement resolution, and associated errors expressed as standard deviation, derived from manufacturer stated 99% instrument accuracy.")
```

Water level transducers were suspended from a brace across a large container
with the transducers zero points aligned. The transducers were covered with a
fixed depth of water and a layer of canola oil was added to prevent evaporation
over the length of the experiment. Water level was measured at the start and end
of the experimental period to confirm no evaporation. To provide thermally
similar air and water environments we placed a graduated cylinder in the center
of the water. The cylinder was partially filled with gravel and water to
counteract the buoyancy of the cylinder. During the two periods with synchronous
thermal regimes the two barometric transducers were suspended directly above the
gravel surface. The entire apparatus was covered loosely with aluminum foil to
prevent direct wind effects. For stable thermal regimes the experiment was
conducted in a non-climate controlled basement to minimize diurnal temperature
fluctuations. Varying thermal regime periods were conducted outdoors, out of
direct solar radiation. The barometric transducers were placed under a black
radiation shield to magnify temperature differentials and purposely induce
errors from rapid temperature fluctuations [@liu-2015]. Compensation models 
(below) were developed using one day of recorded data in the variable, dissimilar
conditions. Compensation model performance was than evaluated against the 
remaining data to evaluate the impact of compensation under various transducer
deployment scenarios.

Transducers were deployed and data retrieved using using Solinst Levellogger v.
4.4.0 software. Transducers were set to record at 1-minute intervals with time
synchronized to computer time at launch. The four experiments were run serially
without retrieving data from the Transducers A settling time of at least 30
minutes was observed after barometric transducers or entire experimental apparatus
were relocated, and exact experiment start and end times were determined in a
post-hoc manner to ensure a suitable setting period.

### Field Data

A sample of representative data were taken from ongoing hydrologic field
research. These data are from a study in the western Upper Peninsula of Michigan
in sites located in black ash wetlands. Details on the hydrology of these sites
can be found in Van Grinsven _et al_ [-@vangrinsven-2017]. The data used in this
analysis are from well water levels collected from a 1.25" driven monitoring
well in a wetland and a 6" parshall flume on an intermittent stream which serves 
as the outflow of this headwater wetland. Well level, flume level, and barometric
data were collected with instruments ######, ######, and ###### respectively. 
Data were collected between ########## and ######## and recorded at 15-minute 
intervals.

## Water Level Compensation

All of the sensors used in this study are designed to measure pressure at a
relatively constant temperature and utilize a fixed water density of 1000 $kg
m^{-3}$ to convert pressure to depth (Personal Communication, Solinst). To
account for the larger range of temperatures observed in this study the recorded
pressure was adjusted to account for the variable density of water. 
$$P_{c} = P\;\mathsf{x}\;\frac{\rho_o}{\rho_T}$$ 
where $\rho_T$ is the density of water ($kg m^) as a
function of temperature taken from [@tanaka-2001, Eq. 1], $\rho_o$ is the assumed
density of water (1000 $kgm^{-3}$, and _P_ and $P_c$ are the observed and 
density-corrected pressure readings in units of depth (cm for this study). Here 
after all references to transducer pressure will refer to the density-compensated
pressure. 

Depth of water ($W_d$) was measured separately for each transducer from the water 
surface to the transducer zero point. Raw water level was calculate for each
water and air transducer pair (n = 36) as the absolute measured water pressure 
minus the absolute air pressure ($L = P_w - P_a$). Water level error 
($\epsilon_L$) was calcuated as calculated water level minus measured water 
depth.

To perform compensation without utilizing a reference pressure, a multivariate
linear model was fit for each pair of water and air transducers using ordinary
least squares. The 36 models took the form

\begin{equation}
\epsilon_L=\beta_0 + \beta_aT_a + \beta_wT_w + \beta_{\Delta T_a}\Delta T_a
(\#eq:comp-base)
\end{equation}

where $T_a$, $T_w$, and $\Delta T_a$ represent air temperature, water temperature,
and change in air temperature respectively. The units of $\Delta T_a$ are set as $0.01^oC\;min^{-1}$ to place them on the same scale as $\epsilon_L$ $T_a$, 
and $T_w$. 

Equation \@ref{eq:comp-base} was fit to the observed data to evaluate the
hypothesis of a single multivariate compensation equation derived from only from
known water depth. To account for the uncertainty of instrument error in the
temperature compensation models, Equation 2 was fit repeatedly using a two-stage
parametric bootstrapping approach [@buonaccorsi-2010]. The two-stage boostrap 
first samples the observed data with replacement to create a data set of equal
size as the observations. For each coordinate ($Y, X_1, X_2, X_3$) an error is
added to each term, drawn from a normal distrubtion centered on zero with 
standard deviation equal to the
known instrument error for each variable (Table \@ref{tab-loggers}). For each transducer pair 1000 models were run.

\begin{equation}
\epsilon_L^* = \epsilon_L + N(0, \sigma_{L'});\;\sigma_{L'} = \sqrt{2\sigma_L^2}\\
T_a^* = T_a + N(0, \sigma_T)\\
T_w^* = T_w + N(0, \sigma_T)\\
\Delta T_a^* = \Delta T_a + N(0, \sigma_{T'});\;\sigma_{T'} = \sqrt{2\sigma_T^2}\\

\epsilon_L^*=\beta_0 + \beta_aT_a^* + \beta_wT_w^* + \beta_{\Delta T_a}\Delta T_a^*
(\#eq:comp-boot)
\end{equation}

where $^*$ denotes bootstrap samples plus instrument error. Bootstrap models 
were generated independently within each of the five experimental periods. Any
slope parameters not significant at $\alpha = 0.05$ were removed and the model
was refit, iteratively until only intercept and any significant predictors 
remained. For
uncertainty analysis each bootstrap model was used to predict $\epsilon_L$ for
the observed samples. To evaluate compensation across conditions the bootstrap
models generated for the *test-data* period were used to predict $\epsilo_L$ for
all of the other experimental periods.

For all predictions, values of $\epsilon_L$ were drawn from a normal
distribution centered on the expected value of $\epsilon_L$ with a standard
deviation equivalent to the residual standard error of the model (Equation
\@ref{eq:estimated-error}. 

\begin{equation}
\hat\epsilon_{L_i} \sim N(\epsilon_L^*, \sigma_{model})
(\#eq:estimated-error)
\end{equation}

where $\hat\epsilon_{L_i}$ is the predicted error for the _i_th record. 
The median of all calcualted $\hat\epsilon_{L_i}$ was used as
predicted error in analysis with upper and lower prediction intervals taken as
the 0.025 and 0.975 quantiles of all calcualted $\hat\epsilon_{L_i}$.

For each water-air transducer pair the correct compensation model was used to
predict the error ($\hat\epsilon_L$), which was used to compensate the recorded
water levels such that $L_c = L - \hat\epsilon_L$.
where $L_c$ denotes the compensated water level. Both $L$ and $L_c$ were then
centered by subtracting the mean of $\epsilon_L$ and $\hat\epsilon_L$, 
respectively.

## Compensation Evaluation

To ensure independent evaluation of the multivariate compensation equation, the
the bootstrapped models from the *test-data* period were evaluated using data
from the remaining 4 experimental periods. Compensation effectiveness was
evaluated based on two criteria: number of recorded points which fell outside of
the range of combined instrument errors ($n_{\epsilon,i}$) and the root mean
squared error (RMSE) from the known water depth. Effect of compensation was 
tested as the pairwise difference in estimated marginal means of the RMSE for 
corrected and uncorrected data within a given experimental period. Additionally 
estimated marginal means of the corrected data RMSE were compared across 
experimental period.

Often the purpose of developing transducer compensations is to correct
field-collected data where true water level is unknown except for a relatively
small collection of manual calibration readings. Representative data from
ongoing field research using these same instruments is evaluated using raw and
compensated water levels. As true water depth was known for so few of the
recorded water level measurements, $n_{\epsilon,i}$ and RMSE were not
calculated. Rather key charactersitics of the resulting time series, magnitude
of the diurnal fluctuation, timing of water level peaks and drawdown, and daily
summary statistics, are compared. These metrics were chosen to illustrate the
impact of compensation on common metrics used in reported hydrologic data.

## Uncertainty Analysis

The impact of temperature-derived errors on water level measurements was 
evaluated by comparing instrument error, propagated error, and measured error of
corrected data. Within each experimental period the magnitude of instrument 
error and propagated error from the bootstrap prediction bounds were compared
using a t-test between the instrument error and propagated error. Using the 
*test-dat* dataset, $\hat\epsilon_L$ was calculated as above, and the difference
between the corrected water level and true water depth was used to calculate new
accuracy bounds. The new accuracy bounds were then tested against the instrument
error bounds using a paired t-test of the standard deviation of the propagated
errors and the stated instrument accuracy.

## Software
All data processing and analysis was performed in R [@rcoreteam-2019] using the
packages `data.table` [@dowle-2019] for data manipulation, `ggplot2`
[@wickham-2016] and `patchwork` [@pedersen-2019a] for visualization. The `drake`
[@landau-2018], `rmarkdown` [@allaire-2020; @xie-2018], `rticles` 
[@allaire-2019], and `rbbt` [@dunnington-2020] packages were used to generate a 
reproducible project and publication.

# Results

## Compensation Effectiveness
The model form described in Equation \@ref{eq:comp-base} showed a good fit to
the *test-data* data with bootstrapped estimates of R^2 ranging from #### to
####. The bootstrap predictions had RMSE values that ranged from #### to ####
cm, which includes the uncertainty inherent in the instrument measurements. When
the *test-data* model was used to predict other experimental periods, the RMSE
relative to true water level showed a mean change of -0.001, -0.058, 0.042, and
-0.614 cm within the _stat-sim_, _stat_dis_, _var-sim_, and _var-dis_
experimental periods respectively. The reduction in RMSE for the _stat-dis_ and
_var-dis_ period were significant at the $\alpha=0.05$ level, as was the
increase in RMSE in the _var-sim_ period. When the two water pressure
transducers that showed outlier model performance (2025928 & 2030899, Figure
#### (RMSE or Sigma plot)) the increase in RMSE in the _var-sim_ period was
reduced to -0.018 and was no longer significant.

Prior to compensation 0 to 57% of measured points fell outside of the 95%
confidence band defined by the combined stated instrument accuracies of the
barometric and water pressure transducers, with only the *var-dis* period
showing more than 1% outside of the error range (Table \@ref(tab:oor)).
Following compensation only 6% of *var-dis* points fell outside of that same
confidence band, but small increases of points outside of the band were observed
for *var-sim* and *stat-sim*. When the interval is expanded to include to
instrument uncertainty and the errors associated with temperature artifacts only
*var-dis* showed any raw data points (35%) outside of the expanded error band.
Following compensation this fell to 0.35% of points for *var-dis* but increased
from 0-0.3% for *var-sim*. All rectified points that fell outside of the
instrument and propogated error bands were associated with the two abnormal
loggers mentioned above.

```{r oor}

predictions <- 
  fread("output/tabular/bootstrap_prediction_values.csv")

predictions[, `:=`(raw_ooir = raw_water_level_cm < instrument_lower | raw_water_level_cm > instrument_upper, 
                 rect_ooir = rect_water_level_cm < instrument_lower | rect_water_level_cm > instrument_upper,
                 raw_oopr = raw_water_level_cm < propagated_lower | raw_water_level_cm > propagated_upper, 
                 rect_oopr = rect_water_level_cm < propagated_lower | rect_water_level_cm > propagated_upper)]

oor_summary <- 
  predictions[, lapply(.SD, sum),
              by = .(water_sn, baro_sn, experiment),
              .SDcols = patterns("_oo")]

oor_count <- 
  oor_summary[, lapply(.SD, sum), by = .(experiment),
              .SDcols = patterns("_oo")]

oor_percent_all_points <-
  oor_count[combined_data$testing[, .N, by = .(experiment)],
            N := i.N,
            on = "experiment"][, lapply(.SD, function(x) 100 * x / N),
                               by = .(experiment),
                               .SDcols = patterns("(w|t)_oo")]

knitr::kable(setNames(oor_percent_all_points, c(" ", "Raw", "Rectified", "Raw", "Rectified")) ,
             align = "c",
             # format = "latex",
             caption = "Percentage of observations of raw and corrected water levels falling outside of instrument accuracy range and propoaged error range (both at $\alpha=0.05$.") %>% 
  kableExtra::add_header_above(header = c("Experimental Period" = 1, "Instrument Error" = 2, "Propogated Error" = 2))

```

## Uncertainty Analysis

Instrument accuracy for all models was either `paste(unique(combined_data$testing$instrument_error_cm), collapse = ", or ")`,
with one of the three transducer models having greater stated accuracy (Table
\@ref(tab:loggers)). 

Due to large discrepancies in model accuracy between the barometric transducers
we compared the propagated errors and the instrument errors separately for each
set of 18 models. For transducer 1066019 the propagated errors were found to be 
significantly less than the instrument error (mean increase in accuracy = 0.17cm).
Transducer 1065861 was found to have propagated errors that were significantly
higher than instrument error (mean decrease in accuracy = 0.05cm).

```{r}
vardis <- predictions[experiment == "var-dis"]
vardis[, propagated_error_cm := rect_water_level_cm - water_depth_cm]
vardis_errors <- 
  vardis[, .(propagated_error_cm = sd(propagated_error_cm),
             instrument_error_cm = mean(instrument_error_cm)), 
         by = .(water_sn, baro_sn)]

lapply(split(vardis_errors, by = "baro_sn"),
       function(x){
         t.test(x$propagated_error_cm, 
                x$instrument_error_cm, 
                # alternative = "less", 
                paired = TRUE)
       }
)

```


We saw that the different thermal regimes in the experiments could still be 
explained by a single unified model.

There should be some variability in the error around points, and if I can 
demonstrate how that varies with the difference between air and water temperature
then I could actually quantify the uncertainty you add to your measurements when
you do not have your loggers in thermally similar regimes

# Conclusions

## Single Equation Compensations

Our results show that for absolute pressure transducers error is introduced
primarily through independent water and air temperature errors. Correcting for
water level error using temperature difference would disregard the differential 
transducer responses. By using the models developed in this study it is possible
to look at the impact of considering temperature differential relative to 
absolute temperature. Figure ### shows the result of simulating errors using a 
fixed water temperature and varying air temperature, and fixed temperature 
differential between varying air and water temperatures. We can see that the
two sources of errors move in opposite directions, and in general the effect of
air temperature along is much larger than the effect of a moving temperature 
differential window. 

Both @cain-2004 and @liu-2015 recommend that lab-based compensation equations be
developed for deployed transducers. Building upon that we have demonstrated that
it is possible to develop a single lab-based correction suitable for varied
deployment environments. However, developing a compensation equation under
conditions similar to field conditions may be more desireable. The degraded
performance under *var-sim* conditions relative to all other periods highlights
this point. Under *var-sim* conditions we observed a small but significant
increase in RMSE for corrected water levels. We believe that the inaccuracies
arise from one of two causes. The first is that the *var-sim* conditions had
higher water levels than any of the other experimental periods. Models developed
on our training data were therefore extrapolating to *var-sim* conditions. The
second possible reason for decreased predictive power is the internal
temperature compensation of the pressure transducers. The data used to train our
models were purposefully collected under the extreme conditions, with
large, rapid temperature fluctuations in both the air and water readings. Under 
these conditions the internal temperature compensation algorithm
is likely overwhelmed. Under conditions with smaller, slower temperature
fluctations, the compensation models tend to overcorrect the data because the
internal temperature compensation has already dampened the temperature-induced
errors. If measurement conditions are similar to compensation conditions, an OLS
regression approach would likely provide improved accuracy at the expense of
generalizability. Idenitying the need for regularization in the compensation
illustrates the importance of using an independent dataset to validate
compensation models. Use of multiple independent validation sets also allow for
the creation of a single model for situations where monitoring conditions may
vary significantly.

The majority of errors in this study are attributable to (**expand with
specifics**) individual transducer The barometric transducer 1065861 appears to
be more sensitive to high rates of temperature change, leading to larger errors
at the beginning and end of the *var-dis* period (Figure ####). This is further
supported by the increased error associated with the compensation models for
transducer 1065861 relative to transducer 1066019 (Figure of sigma distrubtion
of bootstrapped models). Transducers #### and #### also show larger errors, and
account for all of the increase in OOR measurements in the *var-sim* period.
When looking at the distributino of model RMSEs, transducer 2013939 showed no
overlap in the RMSE range of all other models. This suggests that even with
regularization this logger is overfit to the training data, relative to other
models, resulting in degraged performance in the test data. Conversely
transducer 2025928 shows higher RMSE and $\sigma_{mod}$, but no reduction in
$R^2$. It is possible that 2025928 is less sensitive to the models considered,
or is more sensitive to an unmodeled driver (e.g. rate of change of water
temperature). The approach laid out above could, and should, be used to tune the
compensation for individual loggers such as **2025928, 2013939, and 1065861**. That
scale of tuning is outside of the scope of this paper, which is instead focused
on commonalities in compensation that can be applied across instruments and
manufacturers. By including multiple pairs of barometric and water pressure
transducers, we are able to isolate model errors to either the barometric or
water measurements. If multiple loggers are not available for simultanous
compensation performing preliminary or post-correction checks against and
external data source is necessary to account for any errors.

We also showed that it is possible to correct water-depth derived from two
pressure transducers without the need to reference to an external data source.
Any transducer compensation approach must be a trade-off between convenience,
absolute accuracy, and uncertainty. The described approach to compensation
achieves accuracy that corrects 90% of erroneous data to within the bounds 
instrument error and almost all data to within the propagated error bounds.
It can be performed with at a monitoring location with little to no extra
equipment. By minimizing the number of models required for compensation the
multivariate constant water-depth approach also reduces the uncertainty added to
the final water depth measurement. A similar error reduction was performed using
external barometric data and correcting each transducer type separately (data
not shown). These data showed a similar improvement in accuracy but with added
uncertainty from additional compensation models and additional instrument error.

Regularization penalizes variabiles with large slopes. This results in models
that are less prone to overfitting and to being driven entirely by a single
variable. It also has the effective of making the models less sensitive to
predictors. This can be seen in Figure #### where the penalized model from above
is compared to a OLS model with the same form fit to the training data. In the
training data, error is reduced relative to the regularized model, but
increases relative to the regularized model when examining the testing data.

There have been no studies examining the impact of uncertainty of water level
transducer measurements. Additionally no studies looking at the compensation of
water level pressure transducers have been designed to test for commonality of 
compensation approaches across multiple loggers.

Best practice for deploying pressure transducers dictate that the barometric and
water transducers are placed in similar thermal regimes, regardless of available
compensation approaches. However, compensation approaches are a critical tool 
for correcting previous monitoring data that may not have subscribed to best 
practices, or when it is unknown if deployment followed best practices.

```{r intercept_mods}
i_mods <- 
  bootstrap_models[, .(experiment, N = as.numeric(pmax(abs(air_temperature_c), abs(water_temperature_c), abs(delta_at_01c_min)) == 0), sigma)][, .(mean = mean(N), se = sqrt(var(N)/.N), sigma = median(.SD[N > 0, sigma])), keyby = .(experiment)]

imods <- 
  as.list(setNames(100 * set_errors(i_mods$mean, i_mods$se), i_mods$experiment))
```

Of the 1000 models fit per experimental period, `r imods[["stat-sim"]]`% of
*stat-sim*, `r imods[["stat-dis"]]`% of *stat-dis*, and `r imods[["var-sim"]]`%
of *var-sim* final models were intercept-only. These models showed no significant
relationship with air temperature, water temperature, or rate of change of air
temperature. The error associated with 
these models still provides important information regarding true instrument
accuracy. The median value for residual standard deviation for intercept only 
models was 0.32, which is higher than the stated instrument error of any of the
transducer pairs. 

## The Role of Uncertainty in Water Level Measurements
We found that under certain conditions water level errors exceeded instrument
accuracy bounds. Importantly the errors, both within and outside of instrument
accuracy bounds, were correlated with environmental conditions. The problem is
especially vexing because the points that are most likely to lie outside of the
error bounds occur simultaneously with the most extreme temperatures or the
fastest rate of temperature change. These conditions often co-occur with
important hydrologic periods, such as changes in flow following a storm or
periods of peak evapotranspiration. To confidently attribute diurnal or seasonal
signals to true variation rather than error requires additional validation,
specifically when the amplitude of the signal is less than or close to the
instrument error. Validation may take the form of additional instrumentation not
susceptible to the same error source or frequent manual measurements as in
[@cuevas-2010; @gribovszki-2013]. It may also be possible to use the development
of compensation equations to quantify and environmentally-induced errors and
rule them out from causing the signal of interest.

To build additional analyses and models on top of the amplitude and timing of
these signals we must first quanitify the propagated uncertainty. With an 
understanding of the uncertainty and its drivers, we can then evaluate how 
strong the signal is relative to uncertainty. 

One final note, the authors have chosen to focus on trend correction rather than
offset. In general systematic offsets are corrected through manual calibration
measurements during deployment. If deployed conditions will not allow for manual
calibration measurements, the above approaches are applicable, but offsets must
be carefully calculated, which may require external pressure measurements as a
reference.

FIGURE: Create point-range plots of published water level fluctuation rates. Then
add in a threshold line for the median prediction-interval range from this study
to see how often these values could be artifacts and not true measurements

<!-- The median absolute deviation was correlated with ...,  -->
<!-- indicating that is the largest source of error. -->

<!-- Highlight areas where different artifacts are present. Then it can be a guide -->
<!-- for where people should at their data to find artifacts. -->

<!-- Separate out sensor-specific corrections vs generic corrections. Do any appear -->
<!-- to be -->

<!-- I cannot compare if the water level errors are of fixed magnitude or percentage -->
<!-- based. I could make some educated guess from the barometric transducers though. -->

## Recommendations

- We have shown that even with the added uncertainty of rectified barometric
pressure we can provide water level compensations that match those from an
external, reference source. However it is important that during data processing
other stations were found to have different slopes for temperature correction 
models. For use in future work it is recommended that the relationship be 
developed individually for any external stations that may be used to back-fill
missing experimental or monitoring data. Or inversely that back-fill sources
are corrected to match your pressure transducers.

- For each new transducer check for *all* potential error-inducing sources. Each 
transducer should be checked for temperature gradients, temperature difference
gradients to reference values, and rate of change of temperature or pressure

- In this study no mean offset was necessary to account for persistent pressure
errors due to rapid water temperature changes. This is likely because of the
buffered $\Delta T_w$ relative to $\Delta T_a$. In setting where rapid changes
in water temperature are possible calibration should consider including a
persistent impact.

- Develop instrument specific compensation models in similar settings to data
collection. Ideally a known-water level reference model would be developed with
the loggers in situ at the monitoring site. (Describe dry-well deployment)

- Compensation is essential when transducers are deployed in settings with 
variable conditions.

- Even without additional compensation errors, instrument errors can cause errors
of the same order of magnitude as previously published reports

- Do this type of calibration at your field location if possible. Also perform
multiple times in different conditions if possible.

\acknowledgments
The acknowledgments must list:
A statement that indicates to the reader where the data
supporting the conclusions can be obtained (for example, in the
references, tables, supporting information, and other databases).

All funding sources related to this work from all authors

Any real or perceived financial conflicts of interests for any author

Other affiliations for any author that may be perceived as having a conflict of 
interest with respect to the results of this paper.

It is also the appropriate place to thank colleagues and other contributors.

AGU does not normally allow dedications. 

# References
